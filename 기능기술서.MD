# 기능 기술서 (DAN.D – 부산 소상공인 AI 마케팅 매니저)

## 1. 기술 스택 / 실행
- **Frontend**: React + Vite + TypeScript + Tailwind CSS (밝은 블루톤 UI).
- **Backend**: Vercel Serverless Function (`api/generate.js`) – Upstage Solar Pro 호출.
- **데이터/유틸**: 로컬 인사이트(`api/busanData.js`), 축제 CSV 파서(`api/festivalUtils.js`), wttr.in 날씨(`api/weatherUtils.js`).
- **Env**: `.env.local`에 `UPSTAGE_API_KEY` 필요. `vercel dev` 또는 배포 환경에서 `/api/generate`가 활성.

## 2. 주요 사용자 흐름
1) 사용자가 폼에서 **가게명, 주소, 업종(기타 시 직접입력), 메뉴/이벤트/이점, 영업시간, 트렌드 반영 여부**를 입력.
2) `/api/generate`로 POST: 주소를 `location`/`address`로 전달해 구/동 매핑 후 지역 인사이트 조회.
3) 서버리스 함수가 실시간 KST 시각·날씨·축제 컨텍스트와 인사이트·입력 정보를 합쳐 Solar Pro에 프롬프트로 전달.
4) Solar가 JSON `{ feed, story, map, sms }`를 반환 → 프론트가 채널별 문구를 표시/복사.

## 3. Frontend 구현 (주요 파일)
- `src/App.tsx`: 좌측 폼(`PromotionForm`), 우측 결과(`ResultTabs`), 상단 헤더/하단 푸터 배치.
- `src/components/Layout/Header.tsx`: 로고(`@/data/logo.png`) + 서비스명 “DAN.D”.
- `src/components/Layout/Footer.tsx`: 미니멀 텍스트 “DAN.D / Solar”.
- `src/components/Form/PromotionForm.tsx`:
  - 필수 입력: 가게명, 상세 주소(다음/카카오 우편번호 검색 버튼 + datalist), 메뉴/이벤트/이점, 영업시간.
  - 업종 선택(카페/식당/주점/베이커리/뷰티·헤어/기타). 기타 선택 시 직접 업종 입력 필수.
  - 옵션: “오늘 우리 동네 날씨/이슈 반영” 체크박스(기본 ON).
  - 제출 시 `/api/generate`에 `{ storeName, description, location: address, address, businessHours, category, customCategory, includeTrends }` POST.
  - UI: 밝은 블루톤 입력/버튼, 불필요 설명 제거.
- `src/components/Result/ResultTabs.tsx`: 컨텍스트 요약(옵션) + 채널별 문구 블록만 표시.
- `src/components/Result/ResultBlock.tsx`: 복사 버튼 + 본문만 출력(해시태그 배지 제거).
- `src/styles/index.css` / `index.html`: 밝은 배경(화이트+블루 그라디언트), 다크 요소 제거.

## 4. Backend(Serverless) 상세 – `api` 폴더
### 4.1 `api/generate.js`
- **입력**: `storeName, description, location, address, businessHours, category, customCategory, includeTrends`.
- **위치/인사이트**:
  - `location || address` → `getDistrictFromLocation`으로 구/동 매핑.
  - `getInsight`로 지역 인사이트 조회(부분 일치, alias 포함). 매칭되면 **EXPERT**, 아니면 **GENERAL** 모드.
- **실시간 컨텍스트**:
  - 시간대: `Asia/Seoul` 기준 현재 시각에서 요일/시간대 문자열 생성.
  - 날씨: `fetchWeather`(wttr.in) → 실패 시 프리셋.
  - 축제: `getActiveFestivals`(CSV 파싱)로 진행 중/예정 축제 목록을 컨텍스트에 추가.
- **프롬프트 안전장치**:
  - 거짓정보 금지, 입력 없는 주차/가게 크기/영업시간 언급 금지.
  - **영업시간·주소는 입력값을 그대로 사용/포함**하도록 명시.
  - 지역 인사이트(타겟/페르소나/톤/포인트/해시태그) + 업종(기타 시 customCategory) 포함.
  - 채널 규칙: feed(감성+정보, 주소/영업시간 포함, 해시태그 10+), story(2문장 CTA), map(정중, 주소/영업시간만 입력 시 언급), sms(친근, 주소/영업시간 짧게).
  - 트렌드 옵션이 true면 KST 날씨/시간 컨텍스트를 feed/sms에 반드시 반영하도록 지시.
- **출력**: Solar Pro에 JSON 반환을 강제; fenced JSON도 파싱. 실패 시 전체 텍스트를 채널별 동일하게 fallback.
- **응답 페이로드**: `feed/story/map/sms`, `contextSummary`, `results.instagram_*`(기존 UI 호환용, 해시태그 포함).

### 4.2 `api/busanData.js`
- 부산 상권 인사이트(타겟/페르소나/마케팅 포인트/해시태그/톤).
- 키/별칭: 서면/전포·부산진구, 광안리·수영구, 해운대·해운대구, 남포동(자갈치/국제시장)·중구, 기장(오시리아)·기장군, 영도(흰여울)·영도구, 기타(동네).
- `getInsight(location)`: 부분 일치로 키 매칭, 미매칭 시 ‘기타(동네)’ 반환.

### 4.3 `api/festivalUtils.js`
- LOCATION_MAP으로 키워드→구/군 매핑.
- 간단 CSV 파서로 `src/data/busan_festival.csv` 로딩, 운영기간을 날짜로 파싱 → 현재 날짜에 유효한 축제만 필터.
- `getActiveFestivals(location)`: 매핑된 구/군이 일치하는 진행 중 축제 리스트 반환.

### 4.4 `api/weatherUtils.js`
- 주소 문자열 정제(특수문자 제거, “서면/전포”→“서면”) 후 wttr.in으로 날씨 조회.
- 실패 시 “맑은/쌀쌀한…” 프리셋 텍스트 반환.

## 5. 클라이언트 API/훅
- `src/api/client.ts`: axios 인스턴스, `VITE_API_BASE_URL`로 baseURL 설정.
- `src/api/promotion.ts`: `/api/generate` 호출 + 실패 시 목업; `/api/local-context` 목업.
- `src/hooks/useGeneratePromotion.ts`: React Query mutation/query 래퍼.

## 6. 타입
- `src/types/promotion.ts`: 채널/톤/타이밍 타입, 요청/응답 인터페이스 정의(채널별 `text`/`hashtags`).

## 7. 실행 시나리오 요약
1) 폼 작성 → 주소 기반 위치 추론 → 서버에 POST.
2) 서버: 인사이트 매칭 → 실시간 KST 날씨/시간 + 축제 컨텍스트 생성 → Solar Pro 호출.
3) Solar 응답(JSON) → 채널별 문구를 프론트에서 표시/복사. JSON 파싱 실패 시 텍스트 fallback.

## 8. 주의/제한
- 반드시 `UPSTAGE_API_KEY` 설정 후 실행.
- 이미지 입력은 미지원(현재 제거).
- 프리셋 날씨/축제는 네트워크 실패 시 사용되는 텍스트이므로 정확도가 떨어질 수 있음.
